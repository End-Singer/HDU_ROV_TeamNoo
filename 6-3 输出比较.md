## 输出比较
![输入图片说明](/imgs/2025-11-13/p3hoI9ZplVKbqzyL.png)
## PWM介绍
![输入图片说明](/imgs/2025-11-13/Ic40rBoVjE7qAwg1.png)
### 输出比较模式
![输入图片说明](/imgs/2025-11-13/T6f0xOSbBrJetOkC.png)
```
TIM_OCMode_Timing 冻结
TIM_OCMode_Active 匹配时置有效电平
TIM_OCMode_Inactive 匹配时置无效电平
TIM_OCMode_Toggle 匹配时电平翻转
TIM_OCMode_PWM1 PWM1模式
TIM_OCMode_PWM2 PWM2模式
```
### PWM基本结构
![输入图片说明](/imgs/2025-11-13/8xAP0LkPSvfqK7Xw.png)
参数计算
![输入图片说明](/imgs/2025-11-13/t0OlJyuJLDopV4Dw.png)
**PWM频率** = 定时器时钟频率 ÷ (预分频器值 + 1) ÷ (自动重载值 + 1)
**PWM占空比** = 捕获比较寄存器值 ÷ (自动重载值 + 1)
**PWM分辨率** = 1 ÷ (自动重载值 + 1)
### PWM控制的外设
舵机
![输入图片说明](/imgs/2025-11-13/Iz84aoLuOKUTSMCB.png)
直流电机
![输入图片说明](/imgs/2025-11-13/jAh2YcIsV403QWeq.png)
## TIM输出比较配置
1. 时钟配置
2. GPIO模式
3. 定时器参数
4. PWM模式
```c
// 使能TIM2时钟，TIM2挂载在APB1总线上
// 注意：STM32中不同的外设挂载在不同的总线，需要使能对应的时钟
RCC_APB1PeriphClockCmd(RCC_APB1Periph_TIM2, ENABLE);
// 使能GPIOA时钟，GPIO挂载在APB2总线上
// GPIOA的Pin0将用作TIM2的PWM输出通道1
RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOA, ENABLE);

// 配置GPIO为复用推挽输出模式
// 注意：PWM输出需要使用复用功能，不能使用普通推挽输出
GPIO_InitTypeDef GPIO_InitStructure;
GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AF_PP;      // 复用推挽输出模式
GPIO_InitStructure.GPIO_Pin = GPIO_Pin_0;            // 选择Pin0，对应TIM2_CH1
GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;    // 输出速度50MHz
GPIO_Init(GPIOA, &GPIO_InitStructure);

// 配置TIM2使用内部时钟源
TIM_InternalClockConfig(TIM2);

// 配置定时器时基参数
TIM_TimeBaseInitTypeDef TIM_TimeBaseInitStructure;
TIM_TimeBaseInitStructure.TIM_ClockDivision = TIM_CKD_DIV1;     // 时钟分频，不分频
TIM_TimeBaseInitStructure.TIM_CounterMode = TIM_CounterMode_Up; // 向上计数模式
TIM_TimeBaseInitStructure.TIM_Period = 100 - 1;      // 自动重装载值ARR，决定PWM周期
TIM_TimeBaseInitStructure.TIM_Prescaler = 720 - 1;   // 预分频器PSC，决定计数频率
TIM_TimeBaseInitStructure.TIM_RepetitionCounter = 0; // 重复计数寄存器，高级定时器使用
TIM_TimeBaseInit(TIM2, &TIM_TimeBaseInitStructure);

/*
PWM频率计算公式：Fpwm = Fsys / ((ARR + 1) * (PSC + 1))
PWM占空比计算公式：DutyCycle = CCR / (ARR + 1) * 100%

本例参数：
系统时钟Fsys = 72MHz
ARR = 99, PSC = 719
PWM频率 = 72MHz / (100 * 720) = 1000Hz = 1kHz
*/

// 配置TIM2输出比较通道1（OC1）为PWM模式
TIM_OCInitTypeDef TIM_OCInit_Structure;
TIM_OCStructInit(&TIM_OCInit_Structure);  // 初始化结构体为默认值
TIM_OCInit_Structure.TIM_OCMode = TIM_OCMode_PWM1;        // PWM模式1
TIM_OCInit_Structure.TIM_OCPolarity = TIM_OCPolarity_High; // 输出极性高
TIM_OCInit_Structure.TIM_OutputState = TIM_OutputState_Enable; // 使能输出
TIM_OCInit_Structure.TIM_Pulse = 0;        // 捕获比较寄存器CCR值，决定占空比
// 占空比 = CCR / (ARR + 1) = 0~99 / 100 = 0%~99%

TIM_OC1Init(TIM2, &TIM_OCInit_Structure);  // 初始化通道1

// 使能TIM2定时器，开始产生PWM信号
TIM_Cmd(TIM2, ENABLE);
```
## 重映射和解除复用
重映射方式查看STM32F1手册
```c
// 使能AFIO（复用功能IO）时钟，重映射功能必须开启AFIO时钟
// AFIO控制器负责管脚的重映射配置和调试接口配置
RCC_APB2PeriphClockCmd(RCC_APB2Periph_AFIO, ENABLE);

// 将TIM2通道1和通道2进行部分重映射1（Partial Remap 1）
// 默认位置：TIM2_CH1->PA0, TIM2_CH2->PA1
// 重映射后：TIM2_CH1->PA15, TIM2_CH2->PB3
// 用途：当默认引脚被其他功能占用时，可以通过重映射切换到备用引脚
GPIO_PinRemapConfig(GPIO_PartialRemap1_TIM2, ENABLE);

// 禁用JTAG调试接口，释放对应的GPIO引脚用作普通IO功能
// 重映射后：JTAG-DP禁用，但SW-DP保持启用
// 释放的引脚：PA15(JTDI), PA14(JTCK), PA13(JTMS), PB4(JNTRST)
// 注意：这样配置后只能使用SWD接口进行调试
GPIO_PinRemapConfig(GPIO_Remap_SWJ_JTAGDisable, ENABLE);
```
### 详细讲解
#### 重映射（Pin Remapping）
**概念**：STM32的很多外设有多个可选的引脚位置，通过重映射可以将外设功能切换到不同的引脚上。
TIM2重映射选项：![输入图片说明](/imgs/2025-11-13/AMJQMUpasmLDLolb.png)
#### 解除复用（调试接口配置）
![输入图片说明](/imgs/2025-11-13/TE2PvXqAXR044jWP.png)
## 舵机驱动公式计算
**CCR = (目标脉冲宽度 / PWM周期) × (ARR + 1)**
已知舵机输入脉冲周期为 20ms，转90度时高电平时间 0.5ms，那么占空比 = 0.5ms / 20ms，也就等于 CCR / （ARR + 1）；因此可以算出当 ARR + 1 = 20k时，CCR应该为 500
<!--stackedit_data:
eyJoaXN0b3J5IjpbLTk2NzU5MTM3MF19
-->